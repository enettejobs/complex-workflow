name: Complex

on: [push]

jobs:
  ubuntu:
    runs-on: ubuntu-latest
    steps:
      - run: date

  windows:
    runs-on: windows-latest
    needs: ubuntu  # Runs after ubuntu
    steps:
      - name: Check if Key Vault Exists
        shell: pwsh
        run: |
          Write-Host "##vso[task.setvariable variable=resourceExists]true"
      - run: date
      - name: Display Key Vault Properties
        shell: pwsh
        run: |
          Write-Output "Key Vault Properties:"
          Write-Output "test properties"

  infrastructure:
    runs-on: windows-latest
    needs: windows  # Runs after windows job
    displayName: 'Infrastructure Functions'
    strategy:
      runOnce:
        deploy:
          steps:
            - name: Create Key Vault (ARM Template)
              shell: pwsh
              run: |
                # Simulated Key Vault creation command with conditional check on resourceExists
                if ($env:resourceExists -eq "false") {
                  Write-Output "Creating Key Vault..."
                  # Add key vault creation logic here
                } else {
                  Write-Output "Key Vault already exists, skipping creation."
                }
            - name: Display Key Vault Properties
              shell: pwsh
              run: |
                Write-Output "resourceExists:"
                Write-Output "$env:resourceExists"

  macos:
    runs-on: macos-latest
    needs: [ubuntu, windows, infrastructure]  # Runs after all jobs
    steps:
      - run: date
